#!/bin/sh

set -e

mount_virtual()
{
    mount -t proc proc "$1/proc"
    mount -t sysfs sysfs "$1/sys"
}

unmount_virtual()
{
    umount "$1/proc" || true
    umount "$1/sys" || true
}

export LC_ALL=C

if [ "x$1" = x ]
then
    dir="squeeze-chroot"
    snapshot=false
else
    mkdir -p "$1"
    dir="$1/squeeze-chroot"
    snapshot=true
    snapshotdir="$1"
fi
if ([ "x$DEBIAN_MIRROR" = x ] && echo DEBIAN_MIRROR is unspecified >&2) ||
    ([ "x$LFS_MIRROR" = x ] && echo LFS_MIRROR is unspecified >&2)
then
    echo It is recommended that mirrors are used
    if test -t 0 -o -p /dev/stdin; then #check for interactive stdin
        read -p "continue anyway? " || exit 1
    fi
fi
#DEBIAN_MIRROR="http://192.168.1.185/debian"
#LFS_MIRROR=http://192.168.1.185/lfs/

unmount_virtual "$dir"
rm -rf "$dir"
mkdir "$dir"

if "$snapshot" && [ -e "$snapshotdir/squeeze.tar" ]
then
    tar -C "$dir" -xf "$snapshotdir/squeeze.tar"
else
    debootstrap \
    --include=build-essential,\
gawk,bison,python,autoconf,autopoint,automake,gettext,libtool,\
help2man,texinfo,sudo,qemu-utils,parted,kpartx,mbr,extlinux \
squeeze "$dir" "$DEBIAN_MIRROR"
    
    if "$snapshot"
    then
        tar -caf "$snapshotdir/squeeze.tar" -C "$dir" .
    fi
fi

hostname > "$dir/etc/hostname"
cat <<EOF > "$dir/etc/hosts"
127.0.0.1   localhost
127.0.1.1   `hostname`
EOF

cp baserock-bootstrap "$dir/."
if [ "x$LFS_MIRROR" = x ]; then
    cp wget-list "$dir/wget-list"
else
    perl -M'Env' -lpe 's|^.*/|$LFS_MIRROR|' wget-list >"$dir/wget-list"
    #gawk -v m="$LFS_MIRROR" '{gsub(/^.*\//, m)}; 1' wget-list >"$dir/wget-list"
    #sed "s,^.*/,$LFS_MIRROR," wget-list > "$dir/wget-list"
fi

# Unpack existing snapshot, or run pass1 of bootstrap and then make snapshot.
if "$snapshot" && [ -e "$snapshotdir/pass1-snapshot.tar" ]
then
    tar -C "$dir" -xf "$snapshotdir/pass1-snapshot.tar"
else
    if mount_virtual "$dir" && 
       chroot "$dir" bash -x baserock-bootstrap true &&
       unmount_virtual "$dir"
    then
        :
    else
        unmount_virtual "$dir"
        exit 1
    fi

    if "$snapshot"
    then
        tar -C "$dir" -caf "$snapshotdir/pass1-snapshot.tar" .
    fi
fi

# Update the git repos.
mkdir -p "$dir/tree/baserock"
rm -rf "$dir/tree/baserock/gits"
cp -rl "$HOME/baserock/gits" "$dir/tree/baserock/gits"

# Run pass2 of bootstrap. This actually runs pass1 too, but quickly, since
# it's already built.
if mount_virtual "$dir" && 
   chroot "$dir" bash -x baserock-bootstrap false &&
   unmount_virtual "$dir"
then
    :
else
    unmount_virtual "$dir"
    exit 1
fi

